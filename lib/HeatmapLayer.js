'use strict';var _class,_temp;exports.__esModule=!0;exports.computeAggregate=computeAggregate;var _react=require('react'),_react2=_interopRequireDefault(_react),_lodash=require('lodash.map'),_lodash2=_interopRequireDefault(_lodash),_lodash3=require('lodash.reduce'),_lodash4=_interopRequireDefault(_lodash3),_lodash5=require('lodash.filter'),_lodash6=_interopRequireDefault(_lodash5),_lodash7=require('lodash.min'),_lodash8=_interopRequireDefault(_lodash7),_lodash9=require('lodash.max'),_lodash10=_interopRequireDefault(_lodash9),_lodash11=require('lodash.isnumber'),_lodash12=_interopRequireDefault(_lodash11),_leaflet=require('leaflet'),_leaflet2=_interopRequireDefault(_leaflet),_reactLeaflet=require('react-leaflet'),_simpleheat=require('simpleheat'),_simpleheat2=_interopRequireDefault(_simpleheat),_propTypes=require('prop-types'),_propTypes2=_interopRequireDefault(_propTypes);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return b&&('object'==typeof b||'function'==typeof b)?b:a}function _inherits(a,b){if('function'!=typeof b&&null!==b)throw new TypeError('Super expression must either be null or a function, not '+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function isInvalid(a){return!(0,_lodash12.default)(a)&&!a}function isValid(a){return!isInvalid(a)}function isValidLatLngArray(a){return(0,_lodash6.default)(a,isValid).length===a.length}function isInvalidLatLngArray(a){return!isValidLatLngArray(a)}function safeRemoveLayer(a,b){var c=a.getPanes(),d=c.overlayPane;d&&d.contains(b)&&d.removeChild(b)}function shouldIgnoreLocation(a){return isInvalid(a.lng)||isInvalid(a.lat)}function computeAggregate(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:'sum',d=function(b,d,c){var f=a.data.mean+e.mean(a.data.mean,d,c);a.data.sigma+=(c-f)*(c-a.data.mean),a.data.mean=f},e={mean:function d(a,b,c){return(c-a)/b},count:function a(){return 1},sum:function d(a,b,c){return c},distinct:function e(b,d,c){return a.same.add(c),a.same.size},min:function d(a,b,c){return Math.min(a,c)},max:function d(a,b,c){return Math.max(a,c)},variance:function f(b,e,c){return d(b,e,c),1<e?a.data.sigma/(e-1):0},variancep:function f(b,e,c){return d(b,e,c),1<e?a.data.sigma/e:0},stdev:function d(a,b,c){return Math.sqrt(e.variance(a,b,c))},stdevp:function d(a,b,c){return Math.sqrt(e.variancep(a,b,c))}},f=c.toLowerCase();/* eslint-disable no-use-before-define *//* eslint-disable no-unused-vars */a.data[f]||('min'===f?a.data[f]=Number.MAX_SAFE_INTEGER:'max'===f?a.data[f]=Number.MIN_SAFE_INTEGER:['stdev','stdevp','variance','variancep'].includes(f)?(!a.data.mean&&(a.data.mean=0),!a.data.sigma&&(a.data.sigma=0),a.data[f]=0):a.data[f]=0);var g=(e[f]||e.sum)(a.data[f],a.seen,b);return['mean','count','sum'].includes(f)?a.data[f]+=g:a.data[f]=g,a.data[f]}exports.default=(0,_reactLeaflet.withLeaflet)((_temp=_class=function(a){function b(){return _classCallCheck(this,b),_possibleConstructorReturn(this,a.apply(this,arguments))}return _inherits(b,a),b.prototype.createLeafletElement=function a(){return null},b.prototype.componentDidMount=function i(){var b=this,c=this.props.leaflet.map.options.zoomAnimation&&_leaflet2.default.Browser.any3d,d='leaflet-zoom-'+(c?'animated':'hide'),e=this.props.leaflet.map.getSize(),f=_leaflet2.default.DomUtil.testProp(['transformOrigin','WebkitTransformOrigin','msTransformOrigin']);this._el=_leaflet2.default.DomUtil.create('canvas',d),this._el.style[f]='50% 50%',this._el.width=e.x,this._el.height=e.y;var g=this._el,h=_leaflet2.default.Layer.extend({onAdd:function b(a){return a.getPanes().overlayPane.appendChild(g)},addTo:function c(a){return a.addLayer(b),b},onRemove:function b(a){return safeRemoveLayer(a,g)}});this.leafletElement=new h,a.prototype.componentDidMount.call(this),this._heatmap=(0,_simpleheat2.default)(this._el),this.reset(),this.props.fitBoundsOnLoad&&this.fitBounds(),this.attachEvents(),this.updateHeatmapProps(this.getHeatmapProps(this.props))},b.prototype.getMax=function b(a){return(0,_lodash12.default)(a.max)?a.max:3},b.prototype.getRadius=function b(a){return(0,_lodash12.default)(a.radius)?a.radius:30},b.prototype.getMaxZoom=function b(a){return(0,_lodash12.default)(a.maxZoom)?a.maxZoom:18},b.prototype.getMinOpacity=function b(a){return(0,_lodash12.default)(a.minOpacity)?a.minOpacity:.01},b.prototype.getBlur=function b(a){return(0,_lodash12.default)(a.blur)?a.blur:15},b.prototype.getHeatmapProps=function b(a){return{minOpacity:this.getMinOpacity(a),maxZoom:this.getMaxZoom(a),radius:this.getRadius(a),blur:this.getBlur(a),max:this.getMax(a),gradient:a.gradient}},b.prototype.componentWillReceiveProps=function f(a){var b=this.props,c=this.getHeatmapProps(a);this.updateHeatmapGradient(c.gradient);var d=c.radius!==b.radius,e=c.blur!==b.blur;(d||e)&&this.updateHeatmapRadius(c.radius,c.blur),c.max!==b.max&&this.updateHeatmapMax(c.max)},b.prototype.updateHeatmapProps=function b(a){this.updateHeatmapRadius(a.radius,a.blur),this.updateHeatmapGradient(a.gradient),this.updateHeatmapMax(a.max)},b.prototype.updateHeatmapRadius=function c(a,b){(0,_lodash12.default)(a)&&this._heatmap.radius(a,b)},b.prototype.updateHeatmapGradient=function b(a){a&&this._heatmap.gradient(a)},b.prototype.updateHeatmapMax=function b(a){(0,_lodash12.default)(a)&&this._heatmap.max(a)},b.prototype.componentWillUnmount=function a(){safeRemoveLayer(this.props.leaflet.map,this._el)},b.prototype.fitBounds=function f(){var a=this.props.points,b=(0,_lodash2.default)(a,this.props.longitudeExtractor),c=(0,_lodash2.default)(a,this.props.latitudeExtractor),d={lng:(0,_lodash10.default)(b),lat:(0,_lodash10.default)(c)},e={lng:(0,_lodash8.default)(b),lat:(0,_lodash8.default)(c)};shouldIgnoreLocation(d)||shouldIgnoreLocation(e)||this.props.leaflet.map.fitBounds(_leaflet2.default.latLngBounds(_leaflet2.default.latLng(e),_leaflet2.default.latLng(d)))},b.prototype.componentDidUpdate=function a(){this.props.leaflet.map.invalidateSize(),this.props.fitBoundsOnUpdate&&this.fitBounds(),this.reset()},b.prototype.shouldComponentUpdate=function a(){return!0},b.prototype.attachEvents=function c(){var a=this,b=this.props.leaflet.map;b.on('viewreset',function(){return a.reset()}),b.on('moveend',function(){return a.reset()}),b.options.zoomAnimation&&_leaflet2.default.Browser.any3d&&b.on('zoomanim',this._animateZoom,this)},b.prototype._animateZoom=function d(a){var b=this.props.leaflet.map.getZoomScale(a.zoom),c=this.props.leaflet.map._getCenterOffset(a.center)._multiplyBy(-b).subtract(this.props.leaflet.map._getMapPanePos());_leaflet2.default.DomUtil.setTransform?_leaflet2.default.DomUtil.setTransform(this._el,c,b):this._el.style[_leaflet2.default.DomUtil.TRANSFORM]=_leaflet2.default.DomUtil.getTranslateString(c)+' scale('+b+')'},b.prototype.reset=function c(){var a=this.props.leaflet.map.containerPointToLayerPoint([0,0]);_leaflet2.default.DomUtil.setPosition(this._el,a);var b=this.props.leaflet.map.getSize();this._heatmap._width!==b.x&&(this._el.width=this._heatmap._width=b.x),this._heatmap._height!==b.y&&(this._el.height=this._heatmap._height=b.y),!this._heatmap||this._frame||this.props.leaflet.map._animating||(this._frame=_leaflet2.default.Util.requestAnimFrame(this.redraw,this)),this.redraw()},b.prototype.redraw=function r(){var a=this._heatmap._r,b=this.props.leaflet.map.getSize(),c=a/2,d=this.props.leaflet.map._getMapPanePos(),e=d.x%c,f=d.y%c,g=this.props.latitudeExtractor,h=this.props.longitudeExtractor,i=this.props.intensityExtractor,j=function(a,b){return b.contains(a)},k=function(a){return(0,_lodash6.default)(a,function(a){return void 0!==a})},l=function(a){return(0,_lodash4.default)(a,function(a,b){return(0,_lodash2.default)(k(b),function(a){return[Math.round(a[0]),Math.round(a[1]),a[2]]}).concat(a)},[])},m={},n=function(a,b,d,k){return(0,_lodash4.default)(a,function(a,l){var n=[g(l),h(l)];//skip invalid points
if(isInvalidLatLngArray(n))return a;var o=b.latLngToContainerPoint(n);if(!j(o,d))return a;var p=Math.floor((o.x-e)/c)+2,q=Math.floor((o.y-f)/c)+2;a[q]=a[q]||[];var r=a[q][p],s=p+'-'+q;m[s]||(m[s]={data:{},same:new Set,seen:0}),m[s].seen++;var t=i(l),u=computeAggregate(m[s],t,k);return r?(r[0]=(r[0]*r[2]+o.x*u)/(r[2]+u),r[1]=(r[1]*r[2]+o.y*u)/(r[2]+u),r[2]=u):a[q][p]=[o.x,o.y,u],a},[])},o=function(){return new _leaflet2.default.Bounds(_leaflet2.default.point([-a,-a]),b.add([a,a]))},p=function d(a,b,c){return l(n(a,b,o(b),c))}(this.props.points,this.props.leaflet.map,this.props.aggregateType),q=(0,_lodash10.default)(p.map(function(a){return a[2]}));this._heatmap.clear(),this._heatmap.data(p),this.props.useLocalExtrema&&this.updateHeatmapMax(q),this._heatmap.draw(this.getMinOpacity(this.props)),this._frame=null,this.props.onStatsUpdate&&this.props.points&&0<this.props.points.length&&this.props.onStatsUpdate((0,_lodash4.default)(p,function(a,b){return a.max=b[3]>a.max?b[3]:a.max,a.min=b[3]<a.min?b[3]:a.min,a},{min:1/0,max:-Infinity}))},b.prototype.render=function a(){return null},b}(_reactLeaflet.MapLayer),_class.propTypes={points:_propTypes2.default.array.isRequired,longitudeExtractor:_propTypes2.default.func.isRequired,latitudeExtractor:_propTypes2.default.func.isRequired,intensityExtractor:_propTypes2.default.func.isRequired,fitBoundsOnLoad:_propTypes2.default.bool,fitBoundsOnUpdate:_propTypes2.default.bool,onStatsUpdate:_propTypes2.default.func,/* props controlling heatmap generation */max:_propTypes2.default.number,radius:_propTypes2.default.number,maxZoom:_propTypes2.default.number,minOpacity:_propTypes2.default.number,useLocalExtrema:_propTypes2.default.bool,blur:_propTypes2.default.number,gradient:_propTypes2.default.object,aggregateType:_propTypes2.default.oneOf(['mean','count','sum','distinct','min','max','variance','variancep','stdev','stdevp'])},_temp));
